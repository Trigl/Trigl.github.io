---
layout:     post
title:      "湖仓一体架构初探"
#subtitle:   "实现 Full Checkpoint"
date:       2023-02-18 10:00:00
author:     "Ink Bai"
catalog:    true
#header-style: "text"
header-img: "/img/post/lakehouse.jpg"
tags:
    - Big Data
---

> 我在 17 年写过一篇介绍数仓的文章：[数据仓库的架构与设计](/2017/04/01/data-warehouse/)，转眼之间 6 年过去了，技术迭代也是日新月异。你要问最近几年最火的大数据技术，湖仓一体一定会被频繁提及，它也被认为是下一代的数据架构，本文初步介绍一下湖仓一体，尝试解答以下几个问题：
- 数据湖的概念？和数仓有什么区别？
- 为什么要有湖仓一体架构，解决了什么问题？
- 湖仓一体有哪些核心特点？如何实现？

## 数仓简介
早期没有专门的数据分析技术，对于少量的查询需求都是通过数据库实现。随着数据分析需求的增多、需要分析的数据量和种类的增大，数据库的缺点就很明显了，存储和性能上都无法支撑大规模数据分析，并且会影响 OLTP 在线服务，因此产生了专门用于数据分析的技术：数据仓库。

关于数据仓库可以见我的另一篇文章，[数据仓库的架构与设计](/2017/04/01/data-warehouse/)，这里概括下数据仓库的特点：面向主题、数据集成的、数据稳定、随时间变化，存储的都是特定主题的、结构化的数据，主要支撑公司具体业务线的相关决策。

## 什么是数据湖
进入数据仓库的都是结构化的数据，在写入时就会定义好表结构，会选择合适的存储介质来提升查询性能。而在大数据时代，我们从源系统抽取数据时可能无法明确知道这些数据的价值，因此无法给出一个最优的存储方式，所以最优的方式是选择一个易于访问且存储成本低的存储介质。

在我看来，数据湖的本质就是这个存储介质，如果感兴趣的话，你去看不管是维基百科还是各个云厂商如 AWS、微软对数据湖的定义，一个最核心的点就是数据湖是集中式的、可以存储任意格式/规模的数据。

因此，可以说数据湖并不是一种新技术，只是被创造出的一个新名词，从本质上来讲，是一种企业数据架构方法。物理实现上则是一个数据存储平台，用来集中化存储企业内海量的、多来源、多种类的数据，并支持对数据进行快速加工和分析。

甚至很多公司已经在使用数据湖了，比如国内一般把整个 HDFS 叫做数据仓库（广义），有专门的数仓团队，而 Hadoop 正好是最常用的数据湖存储，在国外一般就叫数据湖。

但是，同样要说明的是，大部分的公司虽然在使用数据湖，但并没有使用全部的数据湖技术，而是还是把数据湖当数据仓库来使用，相当于拿着意大利炮当三八大盖使用。为什么会出现这种情况呢，这是因为虽然数据湖本质是一种存储介质，但数据湖本身有很多区别于数仓的技术，而大多数公司并没有使用起来。

## 数据湖和数仓的主要区别
通过阿里云的一张图来看数据湖和数据仓库的主要区别：

![](/img/content/lake-and-dw.jpg)

数据仓库中，数据存储的结构与其定义的 schema 是强匹配的，也就是先建模再使用（schema-on-write），里面的数据需要按照规范放好，存储在仓库中都是结构化数据，可以直接进行分析、查询或展示。很多公司会在使用特定引擎或做一些优化来加速查询，例如预计算或者基于内存的查询，为了查询性能降低了灵活性。

而数据湖存储其中的数据不需要满足特定的 schema，任何格式的数据都可以扔进数据湖。数据使用通常会在读取数据的时候解析 schema（schema-on-read），当处理相应的数据时，再进行转换，也就是说，数据湖对于入湖的数据不做任何规范和约束，只有在于使用时才定义存储格式以便分析使用。数据湖支持的查询引擎就更加通用和多样。

比传统数据仓库的优势的地方是，数据湖还提供了 DBMS 的一些特点：

- ACID
- 数据版本管理
- 审计
- 索引
- 缓存加速
- 查询优化

## 数据湖核心技术
数据湖要解决的核心问题是高效的存储各类数据并支撑上层应用，传统的数据湖一般采用 HDFS 为存储引擎，但在实际应用中面临着难以克服的问题，这直接催生了 Delta、Iceberg 和 Hudi 三大开源数据湖方案，虽然它们开始的时候是为了解决特定的应用问题的，但最终促成了数据湖特征的统一。

Iceberg 在其格式定义和核心能力上最为完善，但是上游引擎的适配上稍显不足；Hudi 基于 Spark 打造了完整的流式数据落地方案，但是其核心抽象较弱，与 Spark 耦合较紧；Delta Lake 同样高度依赖于 Spark 生态圈，与其他引擎的适配尚需时日，虽然这三个方案在设计初衷上稍有不同，但实现的思路和提供的能力却非常相似，我们可以总结出数据湖技术需要具备的能力：

- 同时支持流批处理
- 支持数据更新（Upsert）
- 支持事务（ACID）
- 可扩展的元数据
- 支持多种存储引擎
- 支持多种计算引擎

不同公司根据不同需求选择了不同的数据湖产品，比如阿里云的 DLA 团队选择 Hudi 作为其底层数据湖存储引擎；腾讯选择了 Iceberg 作为他们的数据湖存储引擎。

## 什么是湖仓一体？为什么要有湖仓一体？
从上文看起来数据湖和数据仓库各有优劣，都有各自适合的使用场景。那么到底应该如何选择呢？

![](/img/content/TB1AkEtUlr0gK0jSZFnXXbRRXXa-1594-664.png)

选择数据湖，才能拥有数据的多样与灵活，有利于将不同的数据组合在一起，发现新的规律。

选择数据仓库，才能拥有数据的规范与清晰，有利于数据的便捷使用，也利于数据的长时间存储。

数据湖灵活易上手，对于公司初期发展是好的；数据仓库规范有未来，对于公司的长久发展是好的。最好的形式就是前期在数据湖中进行开发、创造，然后等一切成熟之后，将整理后的数据在数据仓库中存储。

但是这就带来了一个数据迁移问题，需要不断把数据湖中的东西搬运到数据仓库。而且，同一份数据可能在数据湖和数据仓库中均有存储，而后期可能会导致数据的不一致。

如果把湖仓作为一个有机结合的整体来使用是不是就可以避免这个问题？湖仓一体的理念因此而生，即打通数据仓库和数据湖两套体系，让数据和计算在湖和仓之间自由流动，从而构建一个完整的有机的大数据技术生态体系。于是两者的数据都可以随意获取，在灵活与规范之间取得了平衡！

## 湖仓一体架构的实现
首先明确，构建湖仓一体需要解决三个关键问题：

- 湖和仓的数据/元数据无缝打通，且不需要用户人工干预；
- 湖和仓有统一的开发体验，存储在不同系统的数据，可以通过一个统一的开发/管理平台操作；
- 数据湖与数据仓库的数据，系统负责自动 caching/moving，系统可以根据自动的规则决定哪些数据放在数仓，哪些保留在数据湖，进而形成一体化（冷热分离）

这里以阿里云 MaxCompute 为例，看如何解决这三个问题。MaxCompute 在原有的数据仓库架构上，融合了开源数据湖和云上数据湖，最终实现了湖仓一体化的整体架构。在该架构中，尽管底层多套存储系统并存，但通过统一的存储访问层和统一的元数据管理，向上层引擎提供一体的封装接口，用户可以同时查询数据仓库和数据湖中的表。

![](/img/content/cf5b96deb1ed6ac8bb3eb7a68f2e36c3.webp)

针对上面提到的湖仓一体的三个关键问题，MaxCompute 实现了以下 4 个关键技术点。

- 快速接入：多集群网络打通，数据湖和数仓数据可以流通。
- 统一数据/元数据管理：实现湖仓一体化的存储访问层，不仅支持内置优化的存储系统，也无缝的支持外部存储系统。既支持 HDFS 数据湖，也支持 OSS 云存储数据湖，可读写各种开源文件格式。湖仓一体化的元数据管理，实现数据湖和数仓的元数据无缝打通。
- 统一开发体验：数据湖里的 Hive DataBase 映射为 MaxCompute external project，和普通 project 别无二致，同样享受 MaxCompute 数仓里的数据开发、追踪和管理功能。基于 DataWorks 强大的数据开发/管理/治理能力，提供统一的湖仓开发体验，降低两套系统的管理成本。
- 自动数仓：湖仓一体需要用户根据自身资产使用情况将数据在湖和仓之间进行合理的分层和存储，以最大化湖和仓的优势。MaxCompute 开发了一套智能 cache 技术，根据对历史任务的分析来识别数据冷热度，从而自动利用闲时带宽将数据湖中的热数据以高效文件格式 cache 在数据仓库中，进一步加速数据仓库的后续数据加工流程。不仅解决了湖仓之间的带宽瓶颈问题，也达到了无须用户参与即可实现数据分层管理/治理以及性能加速的目的。

## Refer
[数据湖还没玩明白，就别想着湖仓一体了！ by 傅一平](https://mp.weixin.qq.com/s/1uSjr0R7d8G4XnodYSzgSA)
[到底什么是数据湖？全面解读数据湖的缘起、特征、技术、案例和趋势](https://mp.weixin.qq.com/s/ESIFDYBAVMv6Tb_UtrKT2w)
[什么是湖仓一体？它有什么意义？](https://yeecode.top/blog/45/)
[大数据架构系列：如何理解湖仓一体？](https://juejin.cn/post/7143166204550021150)
[数据湖与数据仓库的新未来：阿里提出湖仓一体架构](https://www.infoq.cn/article/gjxescklvdtmaevv9aqa)
